zabbix_export:
  version: '7.4'
  template_groups:
    - uuid: 97d4e446d78440068618d6b4dd128cbf
      name: Templates/Virtualization
  templates:
    - uuid: 6bad1cd915d44e9c91a0dbd20d6f223f
      template: 'Incus Virtual Machine'
      name: 'Incus Virtual Machine'
      description: |
        Template for Incus virtual machine hosts.

        Virtual machines are full QEMU/KVM VMs running complete operating
        systems with hardware emulation.

        This template is automatically linked via host prototype when VMs
        are discovered by the "Incus Cluster Member" template.

        Features:
        - Instance state monitoring (status, CPU, memory)
        - Disk usage monitoring
        - Network interface monitoring (discovered per-interface)
        - Snapshot monitoring (count and age)
        - VM-specific metrics (when available)

        Required macros (set by host prototype):
        - {$INCUS.INSTANCE.NAME} - VM name
        - {$INCUS.INSTANCE.PROJECT} - Incus project name

        Inherited macros (from parent hosts):
        - {$INCUS.API.SCHEME}, {$INCUS.API.PORT}, {$INCUS.MEMBER.ADDRESS}
        - {$INCUS.TLS.CERT}, {$INCUS.TLS.KEY}
        - {$INCUS.STATE.INTERVAL}, threshold macros
      vendor:
        name: Community
        version: 2.0.0
      groups:
        - name: Templates/Virtualization
      items:
        # ============================================================
        # Master Item - Instance State
        # ============================================================
        - uuid: 2d523750d3994f7fbaea008774bc8c3f
          name: 'Incus: Instance state raw'
          type: HTTP_AGENT
          key: incus.instance.state.raw
          delay: '{$INCUS.STATE.INTERVAL}'
          history: '0'
          value_type: TEXT
          description: 'Raw JSON state data for this VM'
          timeout: 30s
          url: '{$INCUS.API.SCHEME}://{$INCUS.MEMBER.ADDRESS}:{$INCUS.API.PORT}/1.0/instances/{$INCUS.INSTANCE.NAME}/state'
          query_fields:
            - name: project
              value: '{$INCUS.INSTANCE.PROJECT}'
          ssl_cert_file: '{$INCUS.TLS.CERT}'
          ssl_key_file: '{$INCUS.TLS.KEY}'
          tags:
            - tag: component
              value: instance
        - uuid: c89aa9b16253459e859db8b7627084c4
          name: 'Incus: Instance info raw'
          type: HTTP_AGENT
          key: incus.instance.info.raw
          delay: '{$INCUS.DATA.INTERVAL}'
          history: '0'
          value_type: TEXT
          description: 'Raw JSON info for this VM (includes snapshots)'
          timeout: 30s
          url: '{$INCUS.API.SCHEME}://{$INCUS.MEMBER.ADDRESS}:{$INCUS.API.PORT}/1.0/instances/{$INCUS.INSTANCE.NAME}'
          query_fields:
            - name: project
              value: '{$INCUS.INSTANCE.PROJECT}'
            - name: recursion
              value: '1'
          ssl_cert_file: '{$INCUS.TLS.CERT}'
          ssl_key_file: '{$INCUS.TLS.KEY}'
          tags:
            - tag: component
              value: instance
        # ============================================================
        # Status Items
        # ============================================================
        - uuid: 94a567a6ebff4ffdb9993d6256737670
          name: 'Incus: Instance status'
          type: DEPENDENT
          key: incus.instance.status
          history: 7d
          value_type: TEXT
          description: 'Instance status (Running, Stopped, Frozen, etc.)'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.metadata.status
              error_handler: CUSTOM_VALUE
              error_handler_params: Unknown
          master_item:
            key: incus.instance.state.raw
          tags:
            - tag: component
              value: instance
          triggers:
            - uuid: e9fa99057afe41d99ea809ad220c95c7
              expression: 'last(/Incus Virtual Machine/incus.instance.status)="Frozen" and {$INCUS.MAINTENANCE}=0'
              name: 'Incus: VM is frozen'
              priority: INFO
              description: 'Virtual machine is in frozen state'
              tags:
                - tag: scope
                  value: notice
            - uuid: 1611bb0a9895436cb286d5ad2184f3e9
              expression: 'last(/Incus Virtual Machine/incus.instance.status)="Error" and {$INCUS.MAINTENANCE}=0'
              name: 'Incus: VM is in error state'
              priority: HIGH
              description: 'Virtual machine is in error state'
              tags:
                - tag: scope
                  value: availability
            - uuid: 3db03200ed9845a1bbdf55a7afbfda33
              expression: 'last(/Incus Virtual Machine/incus.instance.status)="Stopped" and {$INCUS.MAINTENANCE}=0'
              name: 'Incus: VM is stopped'
              priority: WARNING
              description: 'Virtual machine has stopped'
              tags:
                - tag: scope
                  value: availability
        - uuid: f69d55c5c15d4657aebcafd7db66e07d
          name: 'Incus: Instance status code'
          type: DEPENDENT
          key: incus.instance.status_code
          history: 7d
          description: 'Instance status code (numeric)'
          valuemap:
            name: 'Incus Instance Status'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.metadata.status_code
              error_handler: CUSTOM_VALUE
              error_handler_params: '0'
          master_item:
            key: incus.instance.state.raw
          tags:
            - tag: component
              value: instance
        - uuid: 93de02f752544e508d9f2f427fbd5f80
          name: 'Incus: Instance PID'
          type: DEPENDENT
          key: incus.instance.pid
          history: 7d
          trends: '0'
          description: 'QEMU process PID on host'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.metadata.pid
              error_handler: CUSTOM_VALUE
              error_handler_params: '0'
          master_item:
            key: incus.instance.state.raw
          tags:
            - tag: component
              value: instance
        # ============================================================
        # CPU Items
        # ============================================================
        - uuid: 413a46c064d046288fb747ef1c1697d1
          name: 'Incus: Instance CPU usage'
          type: DEPENDENT
          key: incus.instance.cpu
          history: 7d
          units: ns
          description: 'CPU time consumed in nanoseconds'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.metadata.cpu.usage
              error_handler: CUSTOM_VALUE
              error_handler_params: '0'
          master_item:
            key: incus.instance.state.raw
          tags:
            - tag: component
              value: cpu
        # ============================================================
        # Memory Items
        # ============================================================
        - uuid: edd53e33eaa84616a8103faa9cd0f50b
          name: 'Incus: Instance memory usage'
          type: DEPENDENT
          key: incus.instance.memory.usage
          history: 7d
          units: B
          description: 'Memory usage in bytes (as seen by hypervisor)'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.metadata.memory.usage
              error_handler: CUSTOM_VALUE
              error_handler_params: '0'
          master_item:
            key: incus.instance.state.raw
          tags:
            - tag: component
              value: memory
        - uuid: 3f0c2ac6a8d94e90bb9ea8eee26abbf9
          name: 'Incus: Instance memory peak'
          type: DEPENDENT
          key: incus.instance.memory.peak
          history: 7d
          units: B
          description: 'Peak memory usage in bytes'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.metadata.memory.usage_peak
              error_handler: CUSTOM_VALUE
              error_handler_params: '0'
          master_item:
            key: incus.instance.state.raw
          tags:
            - tag: component
              value: memory
        - uuid: 849a35928f0041278314134cd47c5337
          name: 'Incus: Instance memory limit'
          type: DEPENDENT
          key: incus.instance.memory.limit
          history: 7d
          units: B
          description: 'Memory limit/allocation in bytes'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.metadata.memory.total
              error_handler: CUSTOM_VALUE
              error_handler_params: '0'
          master_item:
            key: incus.instance.state.raw
          tags:
            - tag: component
              value: memory
        - uuid: 9420abd81e994fc78be1c4c1c94ccd9b
          name: 'Incus: Instance swap usage'
          type: DEPENDENT
          key: incus.instance.swap.usage
          history: 7d
          units: B
          description: 'Swap usage in bytes'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.metadata.memory.swap_usage
              error_handler: CUSTOM_VALUE
              error_handler_params: '0'
          master_item:
            key: incus.instance.state.raw
          tags:
            - tag: component
              value: memory
        # ============================================================
        # Process Count (inside VM via agent)
        # ============================================================
        - uuid: 523d0a0ae0c8493e87633e17fe3f5e3a
          name: 'Incus: Instance process count'
          type: DEPENDENT
          key: incus.instance.processes
          history: 7d
          description: 'Number of running processes (requires incus-agent in VM)'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.metadata.processes
              error_handler: CUSTOM_VALUE
              error_handler_params: '-1'
          master_item:
            key: incus.instance.state.raw
          tags:
            - tag: component
              value: instance
        # ============================================================
        # Disk Items
        # ============================================================
        - uuid: c728b047e80f43fabff1c53d710fe86c
          name: 'Incus: Instance disk root usage'
          type: DEPENDENT
          key: incus.instance.disk.root.usage
          history: 7d
          units: B
          description: 'Root disk usage in bytes'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.metadata.disk.root.usage
              error_handler: CUSTOM_VALUE
              error_handler_params: '0'
          master_item:
            key: incus.instance.state.raw
          tags:
            - tag: component
              value: disk
        - uuid: b76a23f66a5c404987bc9ef16f684791
          name: 'Incus: Instance disk root total'
          type: DEPENDENT
          key: incus.instance.disk.root.total
          history: 7d
          units: B
          description: 'Root disk total size in bytes'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.metadata.disk.root.total
              error_handler: CUSTOM_VALUE
              error_handler_params: '0'
          master_item:
            key: incus.instance.state.raw
          tags:
            - tag: component
              value: disk
        - uuid: 4777a6d3c0a846e1aa29c69f75c6e513
          name: 'Incus: Instance disk root % used'
          type: CALCULATED
          key: incus.instance.disk.root.pused
          delay: '{$INCUS.STATE.INTERVAL}'
          history: 7d
          value_type: FLOAT
          units: '%'
          params: '100*last(//incus.instance.disk.root.usage)/max(last(//incus.instance.disk.root.total), 1)'
          description: 'Root disk usage percentage (only meaningful with disk quota)'
          tags:
            - tag: component
              value: disk
        # ============================================================
        # Snapshot Items
        # ============================================================
        - uuid: 410e5b1a5a7346a9a6eed6ab5b8aee69
          name: 'Incus: Instance snapshot count'
          type: DEPENDENT
          key: incus.instance.snapshots
          history: 7d
          description: 'Number of snapshots'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.metadata.snapshots
            - type: JAVASCRIPT
              parameters:
                - |
                  var snapshots = JSON.parse(value);
                  return snapshots ? snapshots.length : 0;
          master_item:
            key: incus.instance.info.raw
          tags:
            - tag: component
              value: snapshot
        - uuid: a2f09e8f76b24387af031706547ea0bc
          name: 'Incus: Instance last snapshot age'
          type: DEPENDENT
          key: incus.instance.snapshot.age
          history: 7d
          units: s
          description: 'Age of the most recent snapshot in seconds'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.metadata.snapshots
            - type: JAVASCRIPT
              parameters:
                - |
                  var snapshots = JSON.parse(value);
                  if (!snapshots || snapshots.length === 0) return 0;
                  var newest = 0;
                  var now = Date.now();
                  for (var i = 0; i < snapshots.length; i++) {
                    var ts = new Date(snapshots[i].created_at).getTime();
                    if (ts > newest) newest = ts;
                  }
                  return newest > 0 ? Math.floor((now - newest) / 1000) : 0;
          master_item:
            key: incus.instance.info.raw
          tags:
            - tag: component
              value: snapshot
          triggers:
            - uuid: 440694a24b074c429016505c5a599f93
              expression: 'last(/Incus Virtual Machine/incus.instance.snapshot.age)>{$INCUS.SNAPSHOT.MAXAGE} and last(/Incus Virtual Machine/incus.instance.snapshots)>0 and {$INCUS.MAINTENANCE}=0'
              name: 'Incus: VM snapshot too old (>{$INCUS.SNAPSHOT.MAXAGE})'
              priority: WARNING
              description: 'Most recent snapshot is older than the configured threshold'
              tags:
                - tag: scope
                  value: notice
      # ============================================================
      # Discovery Rules - Network Interfaces
      # ============================================================
      discovery_rules:
        - uuid: f450b7f4989d4b3db1e436322f116f92
          name: 'Incus: Network interfaces discovery'
          type: DEPENDENT
          key: incus.discovery.networks
          filter:
            evaltype: AND
            conditions:
              - macro: '{#IF.NAME}'
                value: '{$INCUS.INTERFACE.IGNORE}'
                operator: NOT_MATCHES_REGEX
          description: 'Discovers network interfaces for this VM'
          item_prototypes:
            - uuid: 3b6ecb136a904763a3864338be9acef2
              name: 'Incus: Interface [{#IF.NAME}] bytes received'
              type: DEPENDENT
              key: 'incus.instance.net.rx.bytes[{#IF.NAME}]'
              history: 7d
              units: B
              description: 'Bytes received on this interface'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.metadata.network["{#IF.NAME}"].counters.bytes_received'
                  error_handler: CUSTOM_VALUE
                  error_handler_params: '0'
              master_item:
                key: incus.instance.state.raw
              tags:
                - tag: component
                  value: network
                - tag: interface
                  value: '{#IF.NAME}'
            - uuid: 2d986a3996a7481f8dad97018e4b0cd2
              name: 'Incus: Interface [{#IF.NAME}] bytes sent'
              type: DEPENDENT
              key: 'incus.instance.net.tx.bytes[{#IF.NAME}]'
              history: 7d
              units: B
              description: 'Bytes sent on this interface'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.metadata.network["{#IF.NAME}"].counters.bytes_sent'
                  error_handler: CUSTOM_VALUE
                  error_handler_params: '0'
              master_item:
                key: incus.instance.state.raw
              tags:
                - tag: component
                  value: network
                - tag: interface
                  value: '{#IF.NAME}'
            - uuid: 1434b59d5d77472bb872c60d10113b56
              name: 'Incus: Interface [{#IF.NAME}] packets received'
              type: DEPENDENT
              key: 'incus.instance.net.rx.packets[{#IF.NAME}]'
              history: 7d
              description: 'Packets received on this interface'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.metadata.network["{#IF.NAME}"].counters.packets_received'
                  error_handler: CUSTOM_VALUE
                  error_handler_params: '0'
              master_item:
                key: incus.instance.state.raw
              tags:
                - tag: component
                  value: network
                - tag: interface
                  value: '{#IF.NAME}'
            - uuid: 54517022961b486491fe69948c9990a9
              name: 'Incus: Interface [{#IF.NAME}] packets sent'
              type: DEPENDENT
              key: 'incus.instance.net.tx.packets[{#IF.NAME}]'
              history: 7d
              description: 'Packets sent on this interface'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.metadata.network["{#IF.NAME}"].counters.packets_sent'
                  error_handler: CUSTOM_VALUE
                  error_handler_params: '0'
              master_item:
                key: incus.instance.state.raw
              tags:
                - tag: component
                  value: network
                - tag: interface
                  value: '{#IF.NAME}'
            - uuid: bfffc000a73344d3be5430985570008b
              name: 'Incus: Interface [{#IF.NAME}] errors received'
              type: DEPENDENT
              key: 'incus.instance.net.rx.errors[{#IF.NAME}]'
              history: 7d
              description: 'Receive errors on this interface'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.metadata.network["{#IF.NAME}"].counters.errors_received'
                  error_handler: CUSTOM_VALUE
                  error_handler_params: '0'
              master_item:
                key: incus.instance.state.raw
              tags:
                - tag: component
                  value: network
                - tag: interface
                  value: '{#IF.NAME}'
            - uuid: b2460073b95441e3b06d1bb8e4b844ba
              name: 'Incus: Interface [{#IF.NAME}] errors sent'
              type: DEPENDENT
              key: 'incus.instance.net.tx.errors[{#IF.NAME}]'
              history: 7d
              description: 'Send errors on this interface'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.metadata.network["{#IF.NAME}"].counters.errors_sent'
                  error_handler: CUSTOM_VALUE
                  error_handler_params: '0'
              master_item:
                key: incus.instance.state.raw
              tags:
                - tag: component
                  value: network
                - tag: interface
                  value: '{#IF.NAME}'
          trigger_prototypes:
            - uuid: de7cbc5d685b43399f7daa24e4176e3b
              expression: 'min(/Incus Virtual Machine/incus.instance.net.rx.errors[{#IF.NAME}],5m)>0 or min(/Incus Virtual Machine/incus.instance.net.tx.errors[{#IF.NAME}],5m)>0 and {$INCUS.MAINTENANCE}=0'
              name: 'Incus: Interface [{#IF.NAME}] has errors'
              priority: WARNING
              description: 'Network errors detected on this interface'
              tags:
                - tag: interface
                  value: '{#IF.NAME}'
                - tag: scope
                  value: performance
          graph_prototypes:
            - uuid: eef41d446e0542fa98da1df7ec7f7f63
              name: 'Incus: Interface [{#IF.NAME}] traffic'
              graph_items:
                - color: 1A7C11
                  calc_fnc: ALL
                  item:
                    host: 'Incus Virtual Machine'
                    key: 'incus.instance.net.rx.bytes[{#IF.NAME}]'
                - color: 2774A4
                  calc_fnc: ALL
                  item:
                    host: 'Incus Virtual Machine'
                    key: 'incus.instance.net.tx.bytes[{#IF.NAME}]'
          master_item:
            key: incus.instance.state.raw
          lld_macro_paths:
            - lld_macro: '{#IF.NAME}'
              path: $.if_name
            - lld_macro: '{#IF.STATE}'
              path: $.if_state
            - lld_macro: '{#IF.TYPE}'
              path: $.if_type
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.metadata.network
            - type: JAVASCRIPT
              parameters:
                - |
                  var networks = JSON.parse(value);
                  var result = [];
                  for (var ifname in networks) {
                    if (networks.hasOwnProperty(ifname)) {
                      result.push({
                        "if_name": ifname,
                        "if_type": networks[ifname].type || "",
                        "if_state": networks[ifname].state || ""
                      });
                    }
                  }
                  return JSON.stringify(result);
      # ============================================================
      # Macros
      # ============================================================
      macros:
        - macro: '{$INCUS.INSTANCE.NAME}'
          description: 'Instance name - set by host prototype'
        - macro: '{$INCUS.INSTANCE.PROJECT}'
          value: default
          description: 'Instance project - set by host prototype'
        - macro: '{$INCUS.MEMBER.ADDRESS}'
          description: 'Member address - inherited from member host'
        - macro: '{$INCUS.API.SCHEME}'
          value: https
          description: 'Protocol scheme (inherited)'
        - macro: '{$INCUS.API.PORT}'
          value: '8443'
          description: 'API port (inherited)'
        - macro: '{$INCUS.TLS.CERT}'
          value: incus-client.crt
          description: 'TLS certificate (inherited)'
        - macro: '{$INCUS.TLS.KEY}'
          value: incus-client.key
          description: 'TLS key (inherited)'
        - macro: '{$INCUS.STATE.INTERVAL}'
          value: 1m
          description: 'State polling interval (inherited)'
        - macro: '{$INCUS.DATA.INTERVAL}'
          value: 5m
          description: 'Data collection interval (inherited)'
        - macro: '{$INCUS.MAINTENANCE}'
          value: '0'
          description: 'Maintenance mode (inherited)'
        - macro: '{$INCUS.INTERFACE.IGNORE}'
          value: ^(lo)$
          description: 'Interface ignore pattern (inherited)'
        - macro: '{$INCUS.SNAPSHOT.MAXAGE}'
          value: 7d
          description: 'Snapshot age threshold (inherited)'
        - macro: '{$INCUS.MEMORY.PUSED.WARN}'
          value: '80'
          description: 'Memory warning threshold (inherited)'
        - macro: '{$INCUS.MEMORY.PUSED.CRIT}'
          value: '95'
          description: 'Memory critical threshold (inherited)'
      # ============================================================
      # Value Maps
      # ============================================================
      valuemaps:
        - uuid: 697fbb3a59084ab090230b62eb91e8d7
          name: 'Incus Instance Status'
          mappings:
            - value: '100'
              newvalue: 'Operation created'
            - value: '101'
              newvalue: Started
            - value: '102'
              newvalue: Stopped
            - value: '103'
              newvalue: Running
            - value: '110'
              newvalue: Frozen
            - value: '112'
              newvalue: Error
